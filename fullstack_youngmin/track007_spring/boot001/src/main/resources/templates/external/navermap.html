<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{fragments/layout}">
<!-- 	#1. layout ë Œë”ë§	 -->
<head lang="ko">
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<div layout:fragment="content">
		<script type="text/javascript"
			src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=4dg215hhw2&callback=initMap"></script>
		<h2 class="mb-3">ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ë§¤ì¥ ì¶”ì²œ</h2>

		<!-- ë²„íŠ¼ ì˜ì—­ -->
		<div class="mb-3">
			<button id="locateBtn" class="btn btn-primary me-2">ë‚´ ìœ„ì¹˜ ì°¾ê¸°</button>
			<button id="showAllBtn" class="btn btn-secondary">ëª¨ë“  ë§¤ì¥ í‘œì‹œ</button>
		</div>

		<!-- ì§€ë„ ì˜ì—­ -->
		<div id="map" class="border rounded"
			style="width: 100%; height: 500px;"></div>

		<!-- ê²°ê³¼ íŒ¨ë„ -->
		<div class="card mt-3">
			<div class="card-body">
				<h5 class="card-title">ì¶”ì²œ ê²°ê³¼</h5>
				<p id="resultText" class="card-text">ì•„ì§ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
				<div id="storeList" class="list-group"></div>
			</div>
		</div>


		<!--  ##2. ì§€ë„ ë„£ê¸°  -->
		<script id="code">
		//$(function(){
			let map;
			let userMarker;
			let stores;
			
			function initMap(){
				//1. ì§€ë„ì´ˆê¸°í™” - ë§¤ì¥ì¢Œí‘œ (dbì—°ë™)
				stores = [ { name: "ê°•ë‚¨ì ", lat: 37.498095, lng: 127.027610 }, 
					{ name: "í™ëŒ€ì ", lat: 37.556343, lng: 126.922651 }, 
					{ name: "ì¸ì²œì ", lat: 37.447275, lng: 126.690894 }, 
					{ name: "ì‹œì²­ì ", lat: 37.566295, lng: 126.977945 }
					];
				
				//2. ì§€ë„ì´ˆê¸°í™” - ì¤‘ì‹¬ìœ„ì¹˜
				map = new naver.maps.Map('map', {
				    center: new naver.maps.LatLng(37.3595704, 127.105399),
				    zoom: 15
				});				
				userMarker = new naver.maps.Marker({
					position: new naver.maps.LatLng(37.3595704,127.105399),
					zIndex:9999, map: map });
				
				document.getElementById("locateBtn").onclick = Recomment; // ì œì¼ê°€ê¹Œìš´ìœ„ì¹˜ì˜ ë§¤ì¥ì¶”ì²œ
				document.getElementById("showAllBtn").onclick = showStores; // ëª¨ë“ ë§¤ì¥
			}
		
			//3. ëª¨ë“ ë§¤ì¥ - ë§ˆì»¤í‘œì‹œ
			function showStores(){
				stores.forEach(store=>{
					const pos = new naver.maps.LatLng(store.lat, store.lng);
					new naver.maps.Marker({position:pos,map:map});
				});
				map.setZoom(10);
				document.getElementById("resultText").textContent="ëª¨ë“  ë§¤ì¥ì„ ì§€ë„ì— í‘œì‹œí–ˆìŠµë‹ˆë‹¤.";
			}
			
			
		   // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
	      function haversine(lat1, lng1, lat2, lng2) {
	        const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
	        const toRad = deg => deg * Math.PI / 180; 
	        const dLat = toRad(lat2 - lat1); 
	        const dLng = toRad(lng2 - lng1); 
	        const a = Math.sin(dLat/2)**2 +
	                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
	                  Math.sin(dLng/2)**2;
	        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
	      }
			
			//4. í˜„ì¬ìœ„ì¹˜ + ê°€ì¥ ê°€ê¹Œìš´ ë§¤ì¥ì¶”ì²œ
			function Recomment(){
				if(!navigator.geolocation){
					alert("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
					return;
				}
				navigator.geolocation.getCurrentPosition(pos=>{
					const lat = pos.coords.latitude;
					const lng = pos.coords.longitude;
					const userPos = new naver.maps.LatLng(lat,lng);
				
					//ì‚¬ìš©ì ìœ„ì¹˜ë§ˆì»¤í‘œì‹œ
					userMarker.setPosition(userPos);
					userMarker.setMap(map);
					map.setCenter(userPos);
					
					//ê°€ì¥ ê°€ê¹Œìš´ ë§¤ì¥ì°¾ê¸°
					let nearest = null;
					stores.forEach(store=> {
						const dist = haversine(lat,lng,store.lat,store.lng);
						if(!nearest || dist < nearest.dist) nearest = {...store, dist};
					});
					
					if(nearest){
						document.getElementById("resultText").innerHTML = 
							`ê°€ì¥ ê°€ê¹Œìš´ ë§¤ì¥ : <span class="text-primary fw-bold">${nearest.name}</span> (${nearest.dist.toFixed(2)}km)`;
						
		                document.getElementById("storeList").innerHTML = 
		                    stores.map(s=>{
		                       const d = haversine(lat, lng, s.lat, s.lng).toFixed(2);
		                       const activeClass = s.name === nearest.name ? "active" : "";
		                       return  `<div class="list-group-item ${activeClass}">${s.name} - ${d} km</div>`;
		                    }).join("");
		              }
				});
			}
			/* //ì§€ë„ë¥¼ ì‚½ì…í•  HTML ìš”ì†Œ ë˜ëŠ” HTML ìš”ì†Œì˜ idë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
			var mapDiv = document.getElementById('map'); // 'map'ìœ¼ë¡œ ì„ ì–¸í•´ë„ ë™ì¼

			//ì˜µì…˜ ì—†ì´ ì§€ë„ ê°ì²´ë¥¼ ìƒì„±í•˜ë©´ ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•˜ëŠ” 16 ë ˆë²¨ì˜ ì§€ë„ê°€ ìƒì„±ë©ë‹ˆë‹¤.
			var map = new naver.maps.Map(mapDiv); */
		</script>
	</div>
	<!-- http://localhost:8484/api/maps -->

</body>
</html>
<!--  4dg215hhw2 -->
<!-- ì˜ˆì‹œì½”ë“œ: https://github.com/navermaps/maps.js.ncp/blob/master/examples/map/1-map-simple.html -->
